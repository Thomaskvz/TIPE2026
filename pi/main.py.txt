import socket
import struct
import time
import sys
import cv2
from picamera2 import Picamera2
from libcamera import Transform


# Usage: python3 client_pi_bw_fps.py <PC_IP> <PORT> [TARGET_FPS]
# SERVER_IP = "172.20.10.5"
SERVER_IP = "192.168.1.136"
SERVER_PORT = 9998
TARGET_FPS = 15.0 

# --- Setup socket ---
client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client_socket.connect((SERVER_IP, SERVER_PORT))
connection = client_socket.makefile('wb')

# --- Setup camera ---
picam2 = Picamera2()
picam2.rotate = 180
picam2.configure(picam2.create_video_configuration(main={"size": (640, 480)}))
Transform(vflip=1)
picam2.start()
time.sleep(2)
print(f"Camera started (grayscale mode, {TARGET_FPS:.1f} FPS limit)...")

encode_param = [int(cv2.IMWRITE_JPEG_QUALITY), 80]
frame_interval = 1.0 / TARGET_FPS
last_capture = 0.0

try:
    while True:
        now = time.time()
        if now - last_capture < frame_interval:
            # maintain desired FPS
            time.sleep(frame_interval - (now - last_capture))
        last_capture = time.time()

        # Capture and process
        frame = picam2.capture_array()
        frame = cv2.cvtColor(frame, cv2.COLOR_RGB2GRAY)

        # Encode as JPEG
        result, img_encode = cv2.imencode('.jpg', frame, encode_param)
        data = img_encode.tobytes()

        # Send frame
        connection.write(struct.pack('<L', len(data)))
        connection.flush()
        connection.write(data)

finally:
    connection.close()
    client_socket.close()
    picam2.close()